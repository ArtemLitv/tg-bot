# Telegram Бот с Настраиваемым Меню, JSON-конфигурацией и Админ-панелью

Telegram бот с настраиваемой системой меню, поддерживающей подменю, различные типы сообщений, JSON-конфигурацию, аналитику пользователей и админ-панель для управления.

## Возможности

### Основные возможности бота
- Настраиваемая система меню из одного файла
- Поддержка JSON-конфигурации для более гибкой настройки
- Мультиязычность (поддержка нескольких языков)
- Поддержка подменю с навигацией
- Различные типы сообщений и узлов:
  - Текстовые сообщения
  - Изображения
  - Ссылки
  - Карты с местоположением
  - Комбинированные сообщения
  - Системные узлы
  - Узлы ввода
  - Узлы задержки

### Аналитика и администрирование
- Сбор и хранение информации о пользователях:
  - Telegram ID
  - Имя/username
  - Язык
  - История переходов по узлам
  - Время последней активности
  - Вводимые данные
  - Текущий узел
- Админ-панель с возможностями:
  - Таблица пользователей с фильтрацией/поиском/сортировкой
  - Просмотр истории переходов пользователей
  - Просмотр и редактирование JSON-конфигурации
  - Просмотр логов
  - Управление ботом (запуск/остановка/перезапуск)
- Защита админ-панели:
  - Авторизация по логину и паролю
  - Поддержка Google OAuth

## Настройка

### Предварительные требования

- Node.js (версия 14 или выше)
- npm или yarn
- Токен Telegram бота (получите его у [@BotFather](https://t.me/BotFather))
- SQLite (встроен в проект)

### Установка

1. Клонируйте этот репозиторий
2. Установите зависимости:
   ```
   npm run setup
   ```
   Эта команда установит все необходимые зависимости для сервера и клиента, а также настроит базу данных.

3. Настройте переменные окружения:
   - Переименуйте файл `.env.example` в `.env` при необходимости
   - Отредактируйте файл `.env`:
     ```
     # Настройки базы данных
     DATABASE_URL="file:./prisma/dev.db"

     # Настройки Telegram-бота
     TELEGRAM_BOT_TOKEN=your_bot_token_here
     BOT_CONFIG_PATH="./config/bot-config.json"

     # Настройки логирования
     LOG_LEVEL="info"

     # Настройки сервера
     PORT=3001
     SESSION_SECRET="change_this_to_a_secure_random_string"

     # Настройки JWT
     JWT_SECRET="change_this_to_a_secure_random_string"
     JWT_EXPIRES_IN="1d"

     # Настройки Google OAuth (опционально)
     GOOGLE_CLIENT_ID=""
     GOOGLE_CLIENT_SECRET=""
     GOOGLE_CALLBACK_URL="http://localhost:3001/auth/google/callback"

     # Настройки администратора по умолчанию
     DEFAULT_ADMIN_USERNAME="admin"
     DEFAULT_ADMIN_PASSWORD="admin"
     DEFAULT_ADMIN_EMAIL="admin@example.com"
     ```

### Запуск проекта

#### Режим разработки

Запуск сервера и клиента одновременно:
```
npm run dev:all
```

Запуск только сервера:
```
npm run dev
```

Запуск только клиента:
```
npm run client
```

#### Производственный режим

Сборка и запуск проекта:
```
npm run deploy
```

Или пошагово:
```
npm run build:all   # Сборка сервера и клиента
npm run start:all   # Запуск собранного проекта
```

### Доступ к админ-панели

После запуска проекта админ-панель будет доступна по адресу [http://localhost:3001/admin](http://localhost:3001/admin).

Данные для входа по умолчанию:
- Логин: `admin`
- Пароль: `admin`

Рекомендуется изменить пароль администратора после первого входа.

## JSON-конфигурация

Помимо настройки меню через файл `src/menu.ts`, бот поддерживает настройку через JSON-конфигурацию, что обеспечивает более гибкую настройку и поддержку мультиязычности.

### Структура JSON-конфигурации

Конфигурация бота представляет собой JSON-файл со следующей структурой:

```json
{
  "start_node_id": "welcome",
  "languages": ["ru", "en"],
  "nodes": [ /* массив узлов */ ]
}
```

### Поля:
- `start_node_id` — ID узла, с которого начинается взаимодействие после команды `/start`.
- `languages` — список поддерживаемых языков (для мультиязычности).
- `nodes` — массив всех нод (сообщений, меню, обработчиков и т.д.).

### Типы узлов

Каждый узел представляет собой отдельную ноду взаимодействия, например: сообщение, меню, система, локация и т.д.

#### Общая структура узла

```json
{
  "id": "уникальный_идентификатор",
  "type": "message | menu | system | location | input | delay",
  "description": "Описание (опционально)",
  "content": { "ru": { ... }, "en": { ... } },
  "buttons": [ /* кнопки переходов */ ],
  "actions": [ /* действия (опционально) */ ],
  "input_handler": { /* ожидаемый ввод (опционально) */ }
}
```

#### Поле `content`

Мультиязычное содержимое сообщения, поддерживает текст, вложения, ссылки, изображения, локации.

```json
"content": {
  "ru": {
    "text": "Добро пожаловать!",
    "format": "markdown",
    "attachments": [
      { "type": "image", "url": "https://example.com/pic.jpg" }
    ]
  },
  "en": {
    "text": "Welcome!",
    "format": "markdown",
    "attachments": []
  }
}
```

#### Возможные вложения (`attachments`):
- `image`: `{ "type": "image", "url": "https://..." }`
- `link`: `{ "type": "link", "text": "Сайт", "url": "https://..." }`
- `location`: `{ "type": "location", "lat": 55.75, "lon": 37.61 }`

#### Кнопки (`buttons`)

Позволяют пользователю переходить к другим узлам.

```json
"buttons": [
  {
    "label": { "ru": "Назад", "en": "Back" },
    "target_node_id": "previous_node_id"
  },
  {
    "label": { "ru": "Подробнее", "en": "Details" },
    "target_node_id": "details_node"
  }
]
```

#### Специальные типы узлов

##### `system`
Узел, который исполняется до /start или выполняет системные действия.

```json
{
  "id": "init",
  "type": "system",
  "actions": [
    {
      "type": "send_message",
      "content": {
        "ru": "Добро пожаловать!",
        "en": "Welcome!"
      }
    }
  ]
}
```

##### `input`
Ожидает пользовательский ввод.

```json
"input_handler": {
  "type": "text | location",
  "prompt": {
    "ru": "Введите ваш город",
    "en": "Enter your city"
  },
  "on_receive": {
    "type": "go_to",
    "target_node_id": "next_node"
  }
}
```

##### `delay` (на будущее)
Позволяет вставлять паузы.

```json
{
  "id": "wait_5_sec",
  "type": "delay",
  "duration": 5000,
  "next": "some_node_id"
}
```

### Пример JSON-конфигурации

В директории `config` находится пример конфигурации `bot-config.json`, который можно использовать в качестве основы для создания собственной конфигурации.

## Фронтенд и админ-панель

Проект включает фронтенд-приложение для визуализации конфигурации бота и админ-панель для управления ботом и анализа данных.

### Визуализация конфигурации

Визуализация конфигурации бота реализована с использованием библиотеки [React Flow](https://reactflow.dev/).

#### Возможности визуализации

- Отображение нод из конфигурации бота в виде графа
- Отображение связей между нодами на основе `target_node_id` и `id`
- Отображение детальной информации о ноде при клике в сайдбаре
- Возможность перемещения и масштабирования графа

### Админ-панель

Админ-панель предоставляет интерфейс для управления ботом и анализа данных о пользователях.

#### Возможности админ-панели

- **Пользователи**: просмотр списка пользователей с фильтрацией, поиском и сортировкой
- **История**: просмотр истории переходов и вводимых данных для каждого пользователя
- **Конфигурация**: просмотр и редактирование JSON-конфигурации бота
- **Логи**: просмотр логов работы бота и сервера
- **Управление ботом**: запуск, остановка и перезапуск бота

### Запуск фронтенда и админ-панели

Для запуска фронтенда и админ-панели выполните следующие команды из корневой директории проекта:

```bash
# Установка зависимостей
npm run client:install

# Запуск в режиме разработки
npm run client
```

Фронтенд для визуализации конфигурации будет доступен по адресу [http://localhost:3000](http://localhost:3000).
Админ-панель будет доступна по адресу [http://localhost:3001/admin](http://localhost:3001/admin) после запуска сервера.

### Структура фронтенда

Фронтенд-приложение находится в директории `client` и имеет следующую структуру:

- `src/App.js` - основной компонент приложения
- `src/components/CustomNode.js` - компонент для кастомизации отображения нод
- `src/components/CustomNode.css` - стили для кастомных нод
- `src/components/NodeSidebar.js` - компонент для отображения информации о ноде в сайдбаре

### Кастомизация нод

Ноды в графе имеют следующую структуру:

1. **Верхняя часть**:
   - Заголовок с описанием ноды
   - Метаданные (ID, тип)
   - Разделительная черта

2. **Нижняя часть**:
   - Слева: bullet-точка, в которую входит соединение от других нод
   - Справа: список кнопок, расположенных вертикально

3. **Соединения**:
   - Входящие соединения приходят в bullet-точку слева
   - Исходящие соединения идут от каждой кнопки справа к соответствующей целевой ноде

Такая структура позволяет наглядно видеть, какие кнопки к каким нодам ведут, и делает граф более понятным и информативным.

Подробная документация по фронтенду доступна в файле [client/README.md](client/README.md).

## Структура проекта

Проект имеет модульную архитектуру и состоит из следующих основных компонентов:

### Серверная часть

Серверная часть проекта находится в директории `server` и построена на Express.js:

- `server/index.ts` - точка входа для сервера Express и Telegram-бота
- `server/bot.ts` - расширение класса Bot для сохранения информации о пользователях в базе данных
- `server/logger.ts` - настройка логирования с использованием Winston

#### Маршруты API

- `server/routes/auth.ts` - маршруты для авторизации
- `server/routes/api.ts` - маршруты API для админ-панели
- `server/routes/bot.ts` - маршруты для управления ботом

#### Сервисы

- `server/services/adminService.ts` - сервис для работы с администраторами
- `server/services/userService.ts` - сервис для работы с пользователями Telegram-бота
- `server/services/configService.ts` - сервис для работы с конфигурацией бота

#### Аутентификация

- `server/auth/passport.ts` - настройка Passport.js для аутентификации

### База данных

Проект использует SQLite в качестве базы данных и Prisma ORM для работы с ней:

- `prisma/schema.prisma` - схема данных Prisma
- `prisma/dev.db` - файл базы данных SQLite (создается автоматически)

#### Модели данных

- `User` - информация о пользователях Telegram-бота
- `NodeHistory` - история переходов пользователя по узлам
- `UserInput` - вводимые пользователем данные
- `Log` - логи работы бота и сервера
- `Admin` - учетные данные администраторов
- `BotConfig` - конфигурация бота

### Логирование

Проект использует Winston для логирования:

- Логи сохраняются в файлы в директории `logs`
- Логи также сохраняются в базу данных
- Уровень логирования настраивается через переменную окружения `LOG_LEVEL`

### Клиентская часть

Клиентская часть проекта находится в директории `client` и построена на React:

- Визуализация конфигурации бота с использованием React Flow
- Админ-панель с использованием Material-UI
- Авторизация с использованием JWT

### Бот

Основная логика бота находится в директории `bot`:

- `bot/index.ts` - точка входа для бота
- `bot/bot.ts` - основной класс бота
- `bot/config-types.ts` - типы для конфигурации бота
- `bot/config-loader.ts` - загрузчик конфигурации
- `bot/node-handlers/` - обработчики различных типов узлов

## Примеры

Стандартное меню включает примеры всех типов сообщений и демонстрацию подменю.

Пример JSON-конфигурации включает примеры различных типов узлов, мультиязычности и других возможностей.

## Лицензия

Этот проект с открытым исходным кодом и доступен под лицензией MIT.
