# Telegram Бот с Настраиваемым Меню и JSON-конфигурацией

Telegram бот с настраиваемой системой меню, поддерживающей подменю, различные типы сообщений и JSON-конфигурацию.

## Возможности

- Настраиваемая система меню из одного файла
- Поддержка JSON-конфигурации для более гибкой настройки
- Мультиязычность (поддержка нескольких языков)
- Поддержка подменю с навигацией
- Различные типы сообщений и узлов:
  - Текстовые сообщения
  - Изображения
  - Ссылки
  - Карты с местоположением
  - Комбинированные сообщения
  - Системные узлы
  - Узлы ввода
  - Узлы задержки

## Настройка

### Предварительные требования

- Node.js (версия 14 или выше)
- npm или yarn
- Токен Telegram бота (получите его у [@BotFather](https://t.me/BotFather))

### Установка

1. Клонируйте этот репозиторий
2. Установите зависимости:
   ```
   npm install
   ```
   или
   ```
   yarn install
   ```
3. Настройте токен вашего бота и путь к JSON-конфигурации:
   - Переименуйте файл `.env` при необходимости
   - Замените `your_bot_token_here` на ваш актуальный токен бота
   - Добавьте путь к JSON-конфигурации (опционально):
     ```
     TELEGRAM_BOT_TOKEN=your_bot_token_here
     BOT_CONFIG_PATH=config/bot-config.json
     ```

### Запуск Бота

Режим разработки (компилирует и запускает):
```
npm run dev
```

Производственный режим (запуск предварительно скомпилированного кода):
```
npm run build
npm start
```

## Настройка Меню

Структура меню определена в файле `src/menu.ts`. Вы можете изменить этот файл для настройки меню вашего бота.

### Структура Элемента Меню

Каждый элемент меню может иметь следующие свойства:

- `title`: Текст, отображаемый на кнопке меню (обязательно)
- `message`: Сообщение, отправляемое при выборе элемента (опционально)
- `subMenu`: Массив элементов подменю (опционально)
- `action`: Специальные действия, например 'back' (назад) (опционально)

### Типы Сообщений

Сообщения могут быть:

- Простой текст: `message: "Hello, world!"`
- Изображение: 
  ```typescript
  message: {
    text: "Подпись к изображению",
    photo: "https://example.com/image.jpg"
  }
  ```
- Ссылка:
  ```typescript
  message: {
    text: "Проверьте эту ссылку:",
    link: {
      url: "https://telegram.org",
      text: "Сайт Telegram"
    }
  }
  ```
- Местоположение:
  ```typescript
  message: {
    text: "Вот местоположение:",
    location: {
      latitude: 55.751244,
      longitude: 37.618423
    }
  }
  ```
- Комбинированное:
  ```typescript
  message: {
    text: "Это комбинированное сообщение",
    photo: "https://example.com/image.jpg",
    link: {
      url: "https://telegram.org",
      text: "Сайт Telegram"
    }
  }
  ```

## JSON-конфигурация

Помимо настройки меню через файл `src/menu.ts`, бот поддерживает настройку через JSON-конфигурацию, что обеспечивает более гибкую настройку и поддержку мультиязычности.

### Структура JSON-конфигурации

Конфигурация бота представляет собой JSON-файл со следующей структурой:

```json
{
  "start_node_id": "welcome",
  "languages": ["ru", "en"],
  "nodes": [ /* массив узлов */ ]
}
```

### Поля:
- `start_node_id` — ID узла, с которого начинается взаимодействие после команды `/start`.
- `languages` — список поддерживаемых языков (для мультиязычности).
- `nodes` — массив всех нод (сообщений, меню, обработчиков и т.д.).

### Типы узлов

Каждый узел представляет собой отдельную ноду взаимодействия, например: сообщение, меню, система, локация и т.д.

#### Общая структура узла

```json
{
  "id": "уникальный_идентификатор",
  "type": "message | menu | system | location | input | delay",
  "description": "Описание (опционально)",
  "content": { "ru": { ... }, "en": { ... } },
  "buttons": [ /* кнопки переходов */ ],
  "actions": [ /* действия (опционально) */ ],
  "input_handler": { /* ожидаемый ввод (опционально) */ }
}
```

#### Поле `content`

Мультиязычное содержимое сообщения, поддерживает текст, вложения, ссылки, изображения, локации.

```json
"content": {
  "ru": {
    "text": "Добро пожаловать!",
    "format": "markdown",
    "attachments": [
      { "type": "image", "url": "https://example.com/pic.jpg" }
    ]
  },
  "en": {
    "text": "Welcome!",
    "format": "markdown",
    "attachments": []
  }
}
```

#### Возможные вложения (`attachments`):
- `image`: `{ "type": "image", "url": "https://..." }`
- `link`: `{ "type": "link", "text": "Сайт", "url": "https://..." }`
- `location`: `{ "type": "location", "lat": 55.75, "lon": 37.61 }`

#### Кнопки (`buttons`)

Позволяют пользователю переходить к другим узлам.

```json
"buttons": [
  {
    "label": { "ru": "Назад", "en": "Back" },
    "target_node_id": "previous_node_id"
  },
  {
    "label": { "ru": "Подробнее", "en": "Details" },
    "target_node_id": "details_node"
  }
]
```

#### Специальные типы узлов

##### `system`
Узел, который исполняется до /start или выполняет системные действия.

```json
{
  "id": "init",
  "type": "system",
  "actions": [
    {
      "type": "send_message",
      "content": {
        "ru": "Добро пожаловать!",
        "en": "Welcome!"
      }
    }
  ]
}
```

##### `input`
Ожидает пользовательский ввод.

```json
"input_handler": {
  "type": "text | location",
  "prompt": {
    "ru": "Введите ваш город",
    "en": "Enter your city"
  },
  "on_receive": {
    "type": "go_to",
    "target_node_id": "next_node"
  }
}
```

##### `delay` (на будущее)
Позволяет вставлять паузы.

```json
{
  "id": "wait_5_sec",
  "type": "delay",
  "duration": 5000,
  "next": "some_node_id"
}
```

### Пример JSON-конфигурации

В директории `config` находится пример конфигурации `bot-config.json`, который можно использовать в качестве основы для создания собственной конфигурации.

## Фронтенд для визуализации конфигурации

Проект включает фронтенд-приложение для визуализации конфигурации бота с использованием библиотеки [React Flow](https://reactflow.dev/).

### Возможности фронтенда

- Отображение нод из конфигурации бота в виде графа
- Отображение связей между нодами на основе `target_node_id` и `id`
- Отображение детальной информации о ноде при клике в сайдбаре
- Возможность перемещения и масштабирования графа

### Запуск фронтенда

Для запуска фронтенда выполните следующие команды из корневой директории проекта:

```bash
# Установка зависимостей
npm run client:install

# Запуск в режиме разработки
npm run client
```

Приложение будет доступно по адресу [http://localhost:3000](http://localhost:3000).

### Структура фронтенда

Фронтенд-приложение находится в директории `client` и имеет следующую структуру:

- `src/App.js` - основной компонент приложения
- `src/components/CustomNode.js` - компонент для кастомизации отображения нод
- `src/components/CustomNode.css` - стили для кастомных нод
- `src/components/NodeSidebar.js` - компонент для отображения информации о ноде в сайдбаре

### Кастомизация нод

Ноды в графе имеют следующую структуру:

1. **Верхняя часть**:
   - Заголовок с описанием ноды
   - Метаданные (ID, тип)
   - Разделительная черта

2. **Нижняя часть**:
   - Слева: bullet-точка, в которую входит соединение от других нод
   - Справа: список кнопок, расположенных вертикально

3. **Соединения**:
   - Входящие соединения приходят в bullet-точку слева
   - Исходящие соединения идут от каждой кнопки справа к соответствующей целевой ноде

Такая структура позволяет наглядно видеть, какие кнопки к каким нодам ведут, и делает граф более понятным и информативным.

Подробная документация по фронтенду доступна в файле [client/README.md](client/README.md).

## Примеры

Стандартное меню включает примеры всех типов сообщений и демонстрацию подменю.

Пример JSON-конфигурации включает примеры различных типов узлов, мультиязычности и других возможностей.

## Лицензия

Этот проект с открытым исходным кодом и доступен под лицензией MIT.
